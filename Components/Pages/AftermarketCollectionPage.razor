@page "/aftermarket-collection"
@rendermode InteractiveServer
@layout MainLayout
@inject AppDbContext DbContext
@inject IJSRuntime JSRuntime
@inject PartTracker.Models.AutomationDbContext AutomationDb

<MudText Typo="Typo.h3">Aftermarket Collection</MudText>

@if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <MudText>Loading data...</MudText>
}
else
{
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4">Today's Bookings</MudText>
        <MudText Typo="Typo.h5" Color="Color.Primary">@todaysBookingsCount bookings made today</MudText>
        <MudText Typo="Typo.h5" Color="Color.Secondary">@totalBookingsCount total bookings made so far</MudText>
        <MudText Typo="Typo.h5" Color="Color.Info">Today's Cost: @todaysCost.ToString("C")</MudText>
        <MudText Typo="Typo.h5" Color="Color.Warning">Total Cost: @totalCost.ToString("C")</MudText>
        <MudText Typo="Typo.h5" Color="Color.Success">Total Aftermarket Collection since Dec 1: @totalAftermarketCollection</MudText>
    </MudPaper>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h4">Cost Histogram (Past 7 Days)</MudText>
        <canvas id="costHistogram" width="400" height="200"></canvas>
    </MudPaper>
}

<div style="margin-top:40px; padding:10px; border:1px solid #ccc;">
    <h4>Add Aftermarket Collection Entry</h4>
    <MudGrid>
        <MudItem xs="12" sm="6">
            <MudTextField @bind-Value="_collection.PN" Label="PN" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudNumericField @bind-Value="_collection.Quantity" Label="Quantity" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12">
            <MudTextField @bind-Value="_collection.Reasons1" Label="Reasons" Variant="Variant.Outlined" Lines="3" />
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudTextField @bind-Value="_collection.CollectedBy" Label="Collected By" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12">
            <MudTextField @bind-Value="_collection.Comment1" Label="Comment" Variant="Variant.Outlined" Lines="2" />
        </MudItem>
    </MudGrid>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="SaveCollection" Disabled="@_adding">@(_editingEntry == null ? "Add Entry" : "Update Entry")</MudButton>
    @if (_message != null)
    {
        <p style="color:@(_success ? "green" : "red");">@_message</p>
    }
</div>

<div style="margin-top:40px;">
    <h4>Aftermarket Collection Entries</h4>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Id</th>
                <th>PN</th>
                <th>Quantity</th>
                <th>Reasons</th>
                <th>Collected By</th>
                <th>Comment</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in _entries)
            {
                <tr>
                    <td>@item.Id</td>
                    <td>@item.PN</td>
                    <td>@item.Quantity</td>
                    <td>@item.Reasons1</td>
                    <td>@item.CollectedBy</td>
                    <td>@item.Comment1</td>
                    <td><MudButton Size="Size.Small" Variant="Variant.Outlined" @onclick="() => EditEntry(item)">Edit</MudButton></td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private int todaysBookingsCount = 0;
    private int totalBookingsCount = 0;
    private decimal todaysCost = 0;
    private decimal totalCost = 0;
    private int totalAftermarketCollection = 0;
    private bool isLoading = true;
    private List<string> chartLabels = new();
    private List<decimal> chartData = new();
    private List<ChangeLogEntry>? _items;
    private string[] allowedAftermarket = {
        "Aftermarket Collection"
    };
    private int daysBack = 25;
    private PartTracker.Models.AftermarketCollectionModel _collection = new();
    private bool _adding;
    private string? _message;
    private bool _success;
    private List<PartTracker.Models.AftermarketCollectionModel> _entries = new();
    private PartTracker.Models.AftermarketCollectionModel? _editingEntry = null;


    protected override async Task OnInitializedAsync()
    {
        _items = await DbContext.ChangeLogEntries.ToListAsync();
        _entries = await AutomationDb.AftermarketCollections.ToListAsync();
        
        todaysBookingsCount = _items.Where(e => 
            e.CompletionTime > DateTime.Now.Date.AddDays(-daysBack) && 
            allowedAftermarket.Contains(e.PremiumBooking)).Count();
        totalBookingsCount = _items.Where(e => 
            allowedAftermarket.Contains(e.PremiumBooking)).Count();

        todaysCost = _items.Where(e => 
            e.CompletionTime > DateTime.Now.Date.AddDays(-daysBack) && 
            allowedAftermarket.Contains(e.PremiumBooking)).Sum(e => e.Cost ?? 0);
        totalCost = _items.Where(e => 
            allowedAftermarket.Contains(e.PremiumBooking)).Sum(e => e.Cost ?? 0);

        // Count parts in transit with LevNr == "BP2TW" since December 1, 2025
        var december1 = new DateTime(2025, 12, 1);
        totalAftermarketCollection = await DbContext.PartsInTransit
            .Where(p => p.LevNr == "BP2TW" && p.AvsDat >= december1)
            .CountAsync();

        isLoading = false;


    }

    private void EditEntry(PartTracker.Models.AftermarketCollectionModel entry)
    {
        _editingEntry = entry;
        _collection = new PartTracker.Models.AftermarketCollectionModel
        {
            Id = entry.Id,
            PN = entry.PN,
            Quantity = entry.Quantity,
            Reasons1 = entry.Reasons1,
            CollectedBy = entry.CollectedBy,
            Comment1 = entry.Comment1
        };
    }

    private async Task SaveCollection()
    {
        _adding = true;
        _message = null;
        _success = false;

        try
        {
            if (_editingEntry == null)
            {
                AutomationDb.AftermarketCollections.Add(_collection);
            }
            else
            {
                AutomationDb.Entry(_editingEntry).CurrentValues.SetValues(_collection);
            }

            await AutomationDb.SaveChangesAsync();
            _entries = await AutomationDb.AftermarketCollections.ToListAsync();
            _message = _editingEntry == null ? "Entry added successfully" : "Entry updated successfully";
            _success = true;
            _collection = new PartTracker.Models.AftermarketCollectionModel();
            _editingEntry = null;
        }
        catch (Exception ex)
        {
            _message = $"Error saving entry: {ex.Message}";
        }
        finally
        {
            _adding = false;
        }
    }
  
}