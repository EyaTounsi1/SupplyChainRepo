@page "/snowflake-test1"
@using System.Data
@using MudBlazor
@inject PartTracker.Shared.Services.SnowflakeService Snowflake
@inject PartTracker.Models.AutomationDbContext AutomationDb

<h3>Snowflake Connection Test</h3>

<div style="margin-bottom:12px;">
    <button @onclick="RunTest" disabled="@_loading">
        Run test query
    </button>

    <button style="margin-left:8px;" @onclick="RunSampleDataQuery" disabled="@_loading">
        Run sample data query (LIMIT 100)
    </button>

    <button style="margin-left:8px;" @onclick="TestPartInfoTable" disabled="@_loading">
        Test PART_INFORMATION_AS_MANUFACTURED table
    </button>

    <button style="margin-left:8px;" @onclick="TestInventoryCoverageTable" disabled="@_loading">
        Test PART_CONSUMPTION_AS_MANUFACTURED table
    </button>
</div>

<div style="margin-top:20px; padding:10px; border:1px solid #ccc;">
    <h4>Update Part Price in Automation DB</h4>
    <MudTextField @bind-Value="_partNumber" Label="Part Number" Variant="Variant.Outlined" Class="min-width-200" />
    <MudTextField @bind-Value="_standardPrice" Label="Standard Price" Variant="Variant.Outlined" Class="min-width-200" />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="UpdatePartPrice" Disabled="@_updating">Update Price</MudButton>
    @if (_updateMessage != null)
    {
        <p style="color:@(_updateSuccess ? "green" : "red");">@_updateMessage</p>
    }
</div>

@if (_loading)
{
    <p><i>Loading...</i></p>
}

@if (!string.IsNullOrWhiteSpace(_error))
{
    <p style="color:red;"><b>@_error</b></p>
}

@if (_showContext && _result != null)
{
    <h4>Snowflake Session Context</h4>

    @if (_result.Rows.Count == 0)
    {
        <p>No rows returned.</p>
    }
    else
    {
        <table border="1" cellpadding="8" style="border-collapse:collapse; max-width:600px;">
            <tbody>
                @foreach (DataColumn col in _result.Columns)
                {
                    <tr>
                        <td style="font-weight:bold; background:#f4f4f4; width:200px;">
                            @col.ColumnName
                        </td>
                        <td>
                            @_result.Rows[0][col]
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (_showSample && _result != null)
{
    <h4>Sample Data (Top 100)</h4>

    @if (_result.Rows.Count == 0)
    {
        <p>No rows returned.</p>
    }
    else
    {
        <div style="max-width:100%; overflow:auto;">
            <table border="1"
                   cellpadding="8"
                   style="border-collapse:collapse; width:max-content; min-width:100%;">
                <thead>
                    <tr>
                        @foreach (DataColumn col in _result.Columns)
                        {
                            <th style="background:#f4f4f4; position:sticky; top:0;">
                                @col.ColumnName
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (DataRow row in _result.Rows)
                    {
                        <tr>
                            @foreach (DataColumn col in _result.Columns)
                            {
                                <td>@row[col]</td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}

<hr />

@code {
    private bool _loading;
    private string? _error;
    private DataTable? _result;

    private bool _showContext;
    private bool _showSample;

    private string _partNumber = "";
    private decimal _standardPrice;
    private bool _updating;
    private string? _updateMessage;
    private bool _updateSuccess;

    private async Task RunTest()
    {
        _loading = true;
        _error = null;
        _result = null;

        _showContext = true;
        _showSample = false;

        try
        {
            _result = await Snowflake.QueryAsync(@"
SELECT
  CURRENT_ROLE()      AS ROLE,
  CURRENT_USER()      AS USERNAME,
  CURRENT_WAREHOUSE() AS WAREHOUSE,
  CURRENT_DATABASE()  AS DATABASE,
  CURRENT_SCHEMA()    AS SCHEMA
");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RunSampleDataQuery()
    {
        _loading = true;
        _error = null;
        _result = null;

        _showContext = false;
        _showSample = true;

        try
        {
            _result = await Snowflake.QueryAsync(@"
select MFG_SUPPLIER_CODE from MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED
where PART_NUMBER = '31493276'  AND SITE = 'VCT';
");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task TestPartInfoTable()
    {
        _loading = true;
        _error = null;
        _result = null;

        _showContext = false;
        _showSample = true;

        try
        {
            _result = await Snowflake.QueryAsync(@"
SELECT
  CURRENT_USER()      AS WHOAMI_USER,
  CURRENT_ROLE()      AS WHOAMI_ROLE,
  CURRENT_WAREHOUSE() AS WHOAMI_WH,
  CURRENT_DATABASE()  AS WHOAMI_DB,
  CURRENT_SCHEMA()    AS WHOAMI_SCHEMA,
  standard_price,
  TYPEOF(standard_price) AS PRICE_TYPE,
  standard_price::VARCHAR AS PRICE_AS_TEXT
FROM MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.PART_INFORMATION_AS_MANUFACTURED.PART_INFORMATION_AS_MANUFACTURED
WHERE PART_NUMBER = '31417637'
  AND TRIM(site) = 'VCT';

");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task TestInventoryCoverageTable()
    {
        _loading = true;
        _error = null;
        _result = null;

        _showContext = false;
        _showSample = true;

        try
        {
            _result = await Snowflake.QueryAsync(@"
SELECT safety_stock_nr_of_parts, SAFETY_STOCK_LEAD_TIME FROM MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED
where part_number='32394630' and site='VCT';

");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpdatePartPrice()
    {
        _updating = true;
        _updateMessage = null;
        _updateSuccess = false;

        try
        {
            if (string.IsNullOrWhiteSpace(_partNumber))
            {
                _updateMessage = "Part number is required.";
                return;
            }

            var partPrice = await AutomationDb.PartPrices.FindAsync(_partNumber);
            if (partPrice == null)
            {
                partPrice = new PartTracker.Models.PartPrice { PartNumber = _partNumber, StandardPrice = _standardPrice };
                AutomationDb.PartPrices.Add(partPrice);
            }
            else
            {
                partPrice.StandardPrice = _standardPrice;
                AutomationDb.PartPrices.Update(partPrice);
            }

            await AutomationDb.SaveChangesAsync();
            _updateMessage = "Part price updated successfully.";
            _updateSuccess = true;
        }
        catch (Exception ex)
        {
            _updateMessage = $"Error updating part price: {ex.Message}";
        }
        finally
        {
            _updating = false;
        }
    }
}
