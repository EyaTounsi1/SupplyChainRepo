@page "/snowflake-test1"
@using System.Data
@inject PartTracker.Shared.Services.SnowflakeService Snowflake

<h3>Snowflake Connection Test</h3>

<div style="margin-bottom:12px;">
    <button @onclick="RunTest" disabled="@_loading">
        Run test query
    </button>

    <button style="margin-left:8px;" @onclick="RunSampleDataQuery" disabled="@_loading">
        Run sample data query (LIMIT 100)
    </button>

    <button style="margin-left:8px;" @onclick="TestPartInfoTable" disabled="@_loading">
        Test PART_INFORMATION_AS_MANUFACTURED table
    </button>

    <button style="margin-left:8px;" @onclick="TestInventoryCoverageTable" disabled="@_loading">
        Test PART_CONSUMPTION_AS_MANUFACTURED table
    </button>
</div>

@if (_loading)
{
    <p><i>Loading...</i></p>
}

@if (!string.IsNullOrWhiteSpace(_error))
{
    <p style="color:red;"><b>@_error</b></p>
}

@if (_showContext && _result != null)
{
    <h4>Snowflake Session Context</h4>

    @if (_result.Rows.Count == 0)
    {
        <p>No rows returned.</p>
    }
    else
    {
        <table border="1" cellpadding="8" style="border-collapse:collapse; max-width:600px;">
            <tbody>
                @foreach (DataColumn col in _result.Columns)
                {
                    <tr>
                        <td style="font-weight:bold; background:#f4f4f4; width:200px;">
                            @col.ColumnName
                        </td>
                        <td>
                            @_result.Rows[0][col]
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (_showSample && _result != null)
{
    <h4>Sample Data (Top 100)</h4>

    @if (_result.Rows.Count == 0)
    {
        <p>No rows returned.</p>
    }
    else
    {
        <div style="max-width:100%; overflow:auto;">
            <table border="1"
                   cellpadding="8"
                   style="border-collapse:collapse; width:max-content; min-width:100%;">
                <thead>
                    <tr>
                        @foreach (DataColumn col in _result.Columns)
                        {
                            <th style="background:#f4f4f4; position:sticky; top:0;">
                                @col.ColumnName
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (DataRow row in _result.Rows)
                    {
                        <tr>
                            @foreach (DataColumn col in _result.Columns)
                            {
                                <td>@row[col]</td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}

<hr />

@code {
    private bool _loading;
    private string? _error;
    private DataTable? _result;

    private bool _showContext;
    private bool _showSample;

    private async Task RunTest()
    {
        _loading = true;
        _error = null;
        _result = null;

        _showContext = true;
        _showSample = false;

        try
        {
            _result = await Snowflake.QueryAsync(@"
SELECT
  CURRENT_ROLE()      AS ROLE,
  CURRENT_USER()      AS USERNAME,
  CURRENT_WAREHOUSE() AS WAREHOUSE,
  CURRENT_DATABASE()  AS DATABASE,
  CURRENT_SCHEMA()    AS SCHEMA
");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RunSampleDataQuery()
    {
        _loading = true;
        _error = null;
        _result = null;

        _showContext = false;
        _showSample = true;

        try
        {
            _result = await Snowflake.QueryAsync(@"
select MFG_SUPPLIER_CODE from MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED
where PART_NUMBER = '31493276'  AND SITE = 'VCT';
");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task TestPartInfoTable()
    {
        _loading = true;
        _error = null;
        _result = null;

        _showContext = false;
        _showSample = true;

        try
        {
            _result = await Snowflake.QueryAsync(@"
SELECT standard_price
FROM MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.PART_INFORMATION_AS_MANUFACTURED.PART_INFORMATION_AS_MANUFACTURED
limit 6;
");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task TestInventoryCoverageTable()
    {
        _loading = true;
        _error = null;
        _result = null;

        _showContext = false;
        _showSample = true;

        try
        {
            _result = await Snowflake.QueryAsync(@"
SELECT PART_CONSUMED_DATE, PART_NUMBER, PART_AMOUNT
FROM MANUFACTURING_ENTERPRISE_DATA_PRODUCTS
     .PART_CONSUMPTION_AS_MANUFACTURED
     .PART_CONSUMPTION_AS_MANUFACTURED
WHERE PART_NUMBER = '31417637'
ORDER BY PART_CONSUMED_DATE
LIMIT 50;

");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
