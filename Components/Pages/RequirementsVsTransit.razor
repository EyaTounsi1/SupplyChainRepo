@page "/ad-hoc/requirements-vs-transit"
@using PartTracker.Shared.Services
@using System.Data
@inject SnowflakeService SnowflakeService

<PageTitle>Requirements vs Transit</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Requirements vs Transit</MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">Filters</MudText>

        <MudGrid>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="partNumber" Label="Part Number" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="supplierCode" Label="Supplier Code" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="LoadData"
                           FullWidth="true"
                           Class="mt-2">
                    Load Data
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mt-4" />
    }
    else if (data.Any())
    {
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">Requirements vs Transit Data</MudText>

            <MudTable Items="@data" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>Part Number</MudTh>
                    <MudTh>Supplier Code</MudTh>
                    <MudTh>Requirement Date</MudTh>
                    <MudTh>Transit Date</MudTh>
                    <MudTh>Status</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Part Number">@context.PartNumber</MudTd>
                    <MudTd DataLabel="Supplier Code">@context.SupplierCode</MudTd>
                    <MudTd DataLabel="Requirement Date">@context.RequirementDate?.ToShortDateString()</MudTd>
                    <MudTd DataLabel="Transit Date">@context.TransitDate?.ToShortDateString()</MudTd>
                    <MudTd DataLabel="Status">@context.Status</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
    else
    {
        <MudText>No data available.</MudText>
    }
</MudContainer>

@code {
    private string partNumber = "";
    private string supplierCode = "";
    private bool isLoading = false;
    private List<RequirementsVsTransitItem> data = new();

    private async Task LoadData()
    {
        isLoading = true;
        data.Clear();

        try
        {
            // Placeholder query - replace with actual logic
            var query = @"
SELECT
    PART_NUMBER,
    SUPPLIER_CODE,
    REQUIREMENT_DATE,
    TRANSIT_DATE,
    CASE
        WHEN TRANSIT_DATE <= REQUIREMENT_DATE THEN 'On Time'
        ELSE 'Delayed'
    END AS STATUS
FROM YOUR_TABLE
WHERE 1=1
" + (!string.IsNullOrEmpty(partNumber) ? $" AND PART_NUMBER = '{EscapeSqlLiteral(partNumber)}'" : "") +
(!string.IsNullOrEmpty(supplierCode) ? $" AND SUPPLIER_CODE = '{EscapeSqlLiteral(supplierCode)}'" : "") +
" ORDER BY REQUIREMENT_DATE DESC LIMIT 100";

            var dt = await SnowflakeService.QueryAsync(query, "ManufacturingEnterpriseDataProducts");

            foreach (DataRow row in dt.Rows)
            {
                data.Add(new RequirementsVsTransitItem
                {
                    PartNumber = row["PART_NUMBER"]?.ToString() ?? "",
                    SupplierCode = row["SUPPLIER_CODE"]?.ToString() ?? "",
                    RequirementDate = row["REQUIREMENT_DATE"] != DBNull.Value ? Convert.ToDateTime(row["REQUIREMENT_DATE"]) : (DateTime?)null,
                    TransitDate = row["TRANSIT_DATE"] != DBNull.Value ? Convert.ToDateTime(row["TRANSIT_DATE"]) : (DateTime?)null,
                    Status = row["STATUS"]?.ToString() ?? ""
                });
            }
        }
        catch (Exception)
        {
            // Handle error
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private static string EscapeSqlLiteral(string value) => value.Replace("'", "''");

    public class RequirementsVsTransitItem
    {
        public string PartNumber { get; set; } = "";
        public string SupplierCode { get; set; } = "";
        public DateTime? RequirementDate { get; set; }
        public DateTime? TransitDate { get; set; }
        public string Status { get; set; } = "";
    }
}