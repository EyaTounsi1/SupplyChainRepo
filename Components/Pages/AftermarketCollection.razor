@page "/aftermarket-collection"
@rendermode InteractiveServer
@layout MainLayout
@inject AppDbContext DbContext
@inject IJSRuntime JSRuntime

<MudText Typo="Typo.h3">Aftermarket Collection</MudText>

@if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <MudText>Loading data...</MudText>
}
else
{
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4">Today's Bookings</MudText>
        <MudText Typo="Typo.h5" Color="Color.Primary">@todaysBookingsCount bookings made today</MudText>
        <MudText Typo="Typo.h5" Color="Color.Secondary">@totalBookingsCount total bookings made so far</MudText>
        <MudText Typo="Typo.h5" Color="Color.Info">Today's Cost: @todaysCost.ToString("C")</MudText>
        <MudText Typo="Typo.h5" Color="Color.Warning">Total Cost: @totalCost.ToString("C")</MudText>
        <MudText Typo="Typo.h5" Color="Color.Success">Total Aftermarket Collection since Dec 1: @totalAftermarketCollection</MudText>
    </MudPaper>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h4">Cost Histogram (Past 7 Days)</MudText>
        <canvas id="costHistogram" width="400" height="200"></canvas>
    </MudPaper>
}

@code {
    private int todaysBookingsCount = 0;
    private int totalBookingsCount = 0;
    private decimal todaysCost = 0;
    private decimal totalCost = 0;
    private int totalAftermarketCollection = 0;
    private bool isLoading = true;
    private List<string> chartLabels = new();
    private List<decimal> chartData = new();
    private List<ChangeLogEntry>? _items;
    private string[] allowedAftermarket = {
        "Aftermarket Collection"
    };
    private int daysBack = 25;


    protected override async Task OnInitializedAsync()
    {
        _items = await DbContext.ChangeLogEntries.ToListAsync();
        
        todaysBookingsCount = _items.Where(e => 
            e.CompletionTime > DateTime.Now.Date.AddDays(-daysBack) && 
            allowedAftermarket.Contains(e.PremiumBooking)).Count();
        totalBookingsCount = _items.Where(e => 
            allowedAftermarket.Contains(e.PremiumBooking)).Count();

        todaysCost = _items.Where(e => 
            e.CompletionTime > DateTime.Now.Date.AddDays(-daysBack) && 
            allowedAftermarket.Contains(e.PremiumBooking)).Sum(e => e.Cost ?? 0);
        totalCost = _items.Where(e => 
            allowedAftermarket.Contains(e.PremiumBooking)).Sum(e => e.Cost ?? 0);

        // Count parts in transit with LevNr == "BP2TW" since December 1, 2025
        var december1 = new DateTime(2025, 12, 1);
        totalAftermarketCollection = await DbContext.PartsInTransit
            .Where(p => p.LevNr == "BP2TW" && p.AvsDat >= december1)
            .CountAsync();

        isLoading = false;


    }
  
}