@page "/safety-stock/simulation"
@using Microsoft.EntityFrameworkCore
@using PartTracker.Shared.Services
@using System.Data
@inject AppDbContext DbContext
@inject SnowflakeService SnowflakeService

<PageTitle>Safety Stock Simulation</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Safety Stock Simulation</MudText>
    
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">Simulation Parameters</MudText>
        
        <MudRadioGroup @bind-Value="simulationMode" Class="mb-3">
            <MudRadio Value="@("Parts")">Simulate by Number of Parts</MudRadio>
            <MudRadio Value="@("LeadTime")">Simulate by Lead Time</MudRadio>
        </MudRadioGroup>
        
        <MudSelect T="string"
                   Label="Time Period for Accumulated Savings"
                   Value="@selectedTimePeriod"
                   ValueChanged="OnTimePeriodChanged"
                   Dense="true"
                   Class="mb-3">
            <MudSelectItem T="string" Value="@("Week")">Per Week</MudSelectItem>
            <MudSelectItem T="string" Value="@("Month")">Per Month</MudSelectItem>
            <MudSelectItem T="string" Value="@("Quarter")">Per Quarter</MudSelectItem>
            <MudSelectItem T="string" Value="@("6Months")">Per 6 Months</MudSelectItem>
            <MudSelectItem T="string" Value="@("Year")">Per Year</MudSelectItem>
        </MudSelect>
        
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="partNumber" Label="Part Number" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="mfgCode" Label="MFG Supplier Code" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="4">
                @if (simulationMode == "Parts")
                {
                    <MudNumericField @bind-Value="newSafetyStockParts" Label="New Safety Stock (Nr of Parts)" Variant="Variant.Outlined" />
                }
                else
                {
                    <MudNumericField @bind-Value="newSafetyStockLeadTime" Label="New Safety Stock Lead Time" Variant="Variant.Outlined" />
                }
            </MudItem>
            <MudItem xs="12">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="RunSimulation" FullWidth="true" Class="mt-2">
                    Run Simulation
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
    }

    @if (simulationResults.Any())
    {
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">Simulation Results</MudText>
            
            <MudTable Items="@simulationResults" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>Site</MudTh>
                    <MudTh>Planning Point</MudTh>
                    <MudTh>Part Number</MudTh>
                    <MudTh>MFG Code</MudTh>
                    @if (simulationMode == "Parts")
                    {
                        <MudTh>Current Safety Stock</MudTh>
                        <MudTh>Standard Price</MudTh>
                        <MudTh>Currency</MudTh>
                        <MudTh>Current Value</MudTh>
                        <MudTh>New Value</MudTh>
                    }
                    else
                    {
                        <MudTh>Current Safety Stock Lead Time</MudTh>
                        <MudTh>Current Cost</MudTh>
                        <MudTh>New Cost</MudTh>
                    }
                    <MudTh>Savings</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Site">@context.Site</MudTd>
                    <MudTd DataLabel="Planning Point">@context.PlanningPoint</MudTd>
                    <MudTd DataLabel="Part Number">@context.PartNumber</MudTd>
                    <MudTd DataLabel="MFG Code">@context.MfgCode</MudTd>
                    @if (simulationMode == "Parts")
                    {
                        <MudTd DataLabel="Current Safety Stock">@context.CurrentSafetyStock</MudTd>
                        <MudTd DataLabel="Standard Price">@context.StandardPrice.ToString("N2")</MudTd>
                        <MudTd DataLabel="Currency">@context.Currency</MudTd>
                        <MudTd DataLabel="Current Value">@context.CurrentValue.ToString("N2")</MudTd>
                        <MudTd DataLabel="New Value">@context.NewValue.ToString("N2")</MudTd>
                    }
                    else
                    {
                        <MudTd DataLabel="Current Safety Stock Lead Time">@context.CurrentSafetyStockLeadTime</MudTd>
                        <MudTd DataLabel="Current Cost">@context.CurrentCost.ToString("N2")</MudTd>
                        <MudTd DataLabel="New Cost">@context.NewCost.ToString("N2")</MudTd>
                    }
                    <MudTd DataLabel="Savings">
                        <MudChip T="string" Color="@(context.Savings > 0 ? Color.Success : Color.Error)" Size="Size.Small">
                            @context.Savings.ToString("N2")
                        </MudChip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

@code {
    private string partNumber = "";
    private string mfgCode = "";
    private string simulationMode = "Parts";
    private int newSafetyStockParts = 0;
    private decimal newSafetyStockLeadTime = 0;
    private List<SafetyStockSimulationResult> simulationResults = new();
    private string errorMessage = "";
    private string selectedTimePeriod = "Year";

    public async Task OnTimePeriodChanged(string? value)
    {
        selectedTimePeriod = value ?? "Year";
        if (simulationResults.Any())
        {
            // Recalculate savings with new time period
            await RecalculateSavings();
        }
        await InvokeAsync(StateHasChanged);
    }

    private string GetSavingsLabel()
    {
        return selectedTimePeriod switch
        {
            "Week" => "Per Week",
            "Month" => "Per Month", 
            "Quarter" => "Per Quarter",
            "6Months" => "Per 6 Months",
            "Year" => "Per Year",
            _ => "Per Year"
        };
    }

    private decimal GetTimeMultiplier()
    {
        return selectedTimePeriod switch
        {
            "Week" => 7m / 365m,
            "Month" => 30.44m / 365m,
            "Quarter" => 91.25m / 365m,
            "6Months" => 182.5m / 365m,
            "Year" => 1m,
            _ => 1m
        };
    }

    private async Task RecalculateSavings()
    {
        var multiplier = GetTimeMultiplier();
        
        foreach (var result in simulationResults)
        {
            result.Savings = result.AnnualSavings * multiplier;
        }
        
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task RunSimulation()
    {
        simulationResults.Clear();
        errorMessage = "";
        
        Dictionary<string, (decimal StandardPrice, string Currency)>? priceMap = null;
        Dictionary<string, (decimal TiedUpCapital, decimal LeadTime)>? costMap = null;
        
        if (simulationMode == "Parts")
        {
            // Load prices from Snowflake PART_INFORMATION_AS_MANUFACTURED table
            string priceSql = @"
SELECT
  SITE,
  PART_NUMBER,
  STANDARD_PRICE,
  CURRENCY
FROM MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.PART_INFORMATION_AS_MANUFACTURED.PART_INFORMATION_AS_MANUFACTURED
WHERE STANDARD_PRICE IS NOT NULL";
            
            DataTable priceTable = await SnowflakeService.QueryAsync(priceSql);
                priceMap ??= new Dictionary<string, (decimal StandardPrice, string Currency)>();
                
                foreach (DataRow priceRow in priceTable.Rows)
                {
                    var site = priceRow["SITE"]?.ToString() ?? "";
                    var partNum = priceRow["PART_NUMBER"]?.ToString() ?? "";
                    var standardPrice = priceRow["STANDARD_PRICE"] != DBNull.Value ? Convert.ToDecimal(priceRow["STANDARD_PRICE"]) : 0m;
                    var currency = priceRow["CURRENCY"]?.ToString() ?? "";
                    
                    var key = $"{site}|{partNum}";
                    priceMap[key] = (standardPrice, currency);
                }
        }
        else
        {
            // Load cost data from Snowflake GIT_CALL_ORDER table
            string costSql = @"
SELECT
  SITE,
  PART_NUMBER,
  TIED_UP_CAPITAL,
  LEAD_TIME
FROM MANUFACTURING_BUSINESS_DATA_PRODUCTS.INVENTORY_BY_PURPOSE.GIT_CALL_ORDER
WHERE TIED_UP_CAPITAL IS NOT NULL AND LEAD_TIME IS NOT NULL";
            
            DataTable costTable = await SnowflakeService.QueryAsync(costSql);
            costMap ??= new Dictionary<string, (decimal TiedUpCapital, decimal LeadTime)>();
            
            foreach (DataRow costRow in costTable.Rows)
            {
                var site = costRow["SITE"]?.ToString() ?? "";
                var partNum = costRow["PART_NUMBER"]?.ToString() ?? "";
                var tiedUpCapital = costRow["TIED_UP_CAPITAL"] != DBNull.Value ? Convert.ToDecimal(costRow["TIED_UP_CAPITAL"]) : 0m;
                var leadTime = costRow["LEAD_TIME"] != DBNull.Value ? Convert.ToDecimal(costRow["LEAD_TIME"]) : 0m;
                
                var key = $"{site}|{partNum}";
                costMap[key] = (tiedUpCapital, leadTime);
            }
        }
        
        string sql = @"
SELECT
  ss.SITE,
  ss.PLANNING_POINT,
  ss.PART_NUMBER,
  ss.MFG_SUPPLIER_CODE,";
        
        if (simulationMode == "Parts")
        {
            sql += @"
  ss.SAFETY_STOCK_LEAD_TIME,";
        }
        else
        {
            sql += @"
  ss.SAFETY_STOCK_LEAD_TIME,";
        }
        
        sql += @"
  ss.UPLOADED_FROM_SOURCE AS SS_UPLOADED_FROM_SOURCE
FROM MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED ss
WHERE 1=1 AND ss.SITE = 'VCT'";

        if (!string.IsNullOrWhiteSpace(partNumber))
        {
            sql += $" AND ss.PART_NUMBER = '{partNumber}'";
        }
        if (!string.IsNullOrWhiteSpace(mfgCode))
        {
            sql += $" AND ss.MFG_SUPPLIER_CODE = '{mfgCode}'";
        }

        sql += " ORDER BY ss.PART_NUMBER DESC";

        try
        {
            DataTable dt = await SnowflakeService.QueryAsync(sql);
            
            foreach (DataRow row in dt.Rows)
            {
                var site = row["SITE"]?.ToString() ?? "";
                var partNum = row["PART_NUMBER"]?.ToString() ?? "";
                
                if (simulationMode == "Parts")
                {
                    var currentStock = Convert.ToInt32(row["SAFETY_STOCK_LEAD_TIME"]);
                    
                    // Get price from Snowflake PART_INFORMATION_AS_MANUFACTURED table
                    decimal price = 0;
                    string currency = "";
                    
                    var priceKey = $"{site}|{partNum}";
                    if (priceMap!.TryGetValue(priceKey, out var priceInfo))
                    {
                        price = priceInfo.StandardPrice;
                        currency = priceInfo.Currency;
                    }
                    
                    var currentValue = currentStock * price;
                    var newValue = newSafetyStockParts * price;
                    var annualSavings = currentValue - newValue;
                    var savings = annualSavings * GetTimeMultiplier();
                    
                    simulationResults.Add(new SafetyStockSimulationResult
                    {
                        Site = site,
                        PlanningPoint = row["PLANNING_POINT"]?.ToString() ?? "",
                        PartNumber = partNum,
                        MfgCode = row["MFG_SUPPLIER_CODE"]?.ToString() ?? "",
                        CurrentSafetyStock = currentStock,
                        StandardPrice = price,
                        Currency = currency,
                        CurrentValue = currentValue,
                        NewValue = newValue,
                        AnnualSavings = annualSavings,
                        Savings = savings
                    });
                }
                else
                {
                    var currentLeadTime = row["SAFETY_STOCK_LEAD_TIME"] != DBNull.Value ? Convert.ToDecimal(row["SAFETY_STOCK_LEAD_TIME"]) : 0m;
                    
                    // Get cost data from GIT_CALL_ORDER table
                    decimal tiedUpCapital = 0;
                    decimal leadTime = 0;
                    
                    var costKey = $"{site}|{partNum}";
                    if (costMap!.TryGetValue(costKey, out var costInfo))
                    {
                        tiedUpCapital = costInfo.TiedUpCapital;
                        leadTime = costInfo.LeadTime;
                    }
                    
                    // Cost per shift = TIED_UP_CAPITAL / (LEAD_TIME * 3)
                    var currentCost = leadTime != 0 ? tiedUpCapital / (leadTime * 3) : 0;
                    var newCost = newSafetyStockLeadTime != 0 ? tiedUpCapital / (newSafetyStockLeadTime * 3) : 0;
                    var annualSavings = currentCost - newCost;
                    var savings = annualSavings * GetTimeMultiplier();
                    
                    simulationResults.Add(new SafetyStockSimulationResult
                    {
                        Site = site,
                        PlanningPoint = row["PLANNING_POINT"]?.ToString() ?? "",
                        PartNumber = partNum,
                        MfgCode = row["MFG_SUPPLIER_CODE"]?.ToString() ?? "",
                        CurrentSafetyStockLeadTime = currentLeadTime,
                        CurrentCost = currentCost,
                        NewCost = newCost,
                        AnnualSavings = annualSavings,
                        Savings = savings
                    });
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error running simulation: {ex.Message}";
        }
    }

    public class SafetyStockSimulationResult
    {
        public string Site { get; set; } = "";
        public string PlanningPoint { get; set; } = "";
        public string PartNumber { get; set; } = "";
        public string MfgCode { get; set; } = "";
        // For Parts mode
        public int CurrentSafetyStock { get; set; }
        public decimal StandardPrice { get; set; }
        public string Currency { get; set; } = "";
        public decimal CurrentValue { get; set; }
        public decimal NewValue { get; set; }
        // For Lead Time mode
        public decimal CurrentSafetyStockLeadTime { get; set; }
        public decimal CurrentCost { get; set; }
        public decimal NewCost { get; set; }
        // Common
        public decimal AnnualSavings { get; set; }
        public decimal Savings { get; set; }
    }
}
