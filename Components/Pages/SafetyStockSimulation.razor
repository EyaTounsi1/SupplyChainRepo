@page "/safety-stock/simulation"
@using System.Data
@using PartTracker.Shared.Services
@inject SnowflakeService SnowflakeService

<PageTitle>Safety Stock Simulation</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Safety Stock Simulation</MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">Simulation Parameters</MudText>

        <MudRadioGroup @bind-Value="simulationMode" Class="mb-3">
            <MudRadio Value="@("Parts")">Simulate by Number of Parts</MudRadio>
            <MudRadio Value="@("LeadTime")">Simulate by Lead Time</MudRadio>
        </MudRadioGroup>

        <MudSelect T="string"
                   Label="Time Period for Accumulated Savings"
                   @bind-Value="selectedTimePeriod"
                   @bind-Value:after="OnTimePeriodChanged"
                   Dense="true"
                   Class="mb-3">
            <MudSelectItem T="string" Value="@("Week")">Per Week</MudSelectItem>
            <MudSelectItem T="string" Value="@("Month")">Per Month</MudSelectItem>
            <MudSelectItem T="string" Value="@("Quarter")">Per Quarter</MudSelectItem>
            <MudSelectItem T="string" Value="@("6Months")">Per 6 Months</MudSelectItem>
            <MudSelectItem T="string" Value="@("Year")">Per Year</MudSelectItem>
        </MudSelect>

        <MudGrid>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="partNumber" Label="Part Number" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="mfgCode" Label="MFG Supplier Code" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" md="4">
                @if (simulationMode == "Parts")
                {
                    <MudNumericField T="int"
                                     @bind-Value="newSafetyStockParts"
                                     Label="New Safety Stock (Nr of Parts)"
                                     Variant="Variant.Outlined" />
                }
                else
                {
                    <MudNumericField T="decimal"
                                     @bind-Value="newSafetyStockLeadTime"
                                     Label="New Safety Stock Lead Time"
                                     Variant="Variant.Outlined" />
                }
            </MudItem>
            <MudItem xs="12">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="RunSimulation"
                           FullWidth="true"
                           Class="mt-2">
                    Run Simulation
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
    }

    @if (simulationResults.Any())
    {
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3">Simulation Results</MudText>

            <MudTable Items="@simulationResults" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>Site</MudTh>
                    <MudTh>Planning Point</MudTh>
                    <MudTh>Part Number</MudTh>
                    <MudTh>MFG Code</MudTh>

                    @if (simulationMode == "Parts")
                    {
                        <MudTh>Current Safety Stock</MudTh>
                        <MudTh>Standard Price</MudTh>
                        <MudTh>Currency</MudTh>
                        <MudTh>Current Value</MudTh>
                        <MudTh>New Value</MudTh>
                    }
                    else
                    {
                        <MudTh>Current Safety Stock Lead Time</MudTh>
                        <MudTh>Current Cost</MudTh>
                        <MudTh>New Cost</MudTh>
                    }

                    <MudTh>@($"Savings {GetSavingsLabel()}")</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="Site">@context.Site</MudTd>
                    <MudTd DataLabel="Planning Point">@context.PlanningPoint</MudTd>
                    <MudTd DataLabel="Part Number">@context.PartNumber</MudTd>
                    <MudTd DataLabel="MFG Code">@context.MfgCode</MudTd>

                    @if (simulationMode == "Parts")
                    {
                        <MudTd DataLabel="Current Safety Stock">@context.CurrentSafetyStock</MudTd>
                        <MudTd DataLabel="Standard Price">@context.StandardPrice.ToString("N2")</MudTd>
                        <MudTd DataLabel="Currency">@context.Currency</MudTd>
                        <MudTd DataLabel="Current Value">@context.CurrentValue.ToString("N2")</MudTd>
                        <MudTd DataLabel="New Value">@context.NewValue.ToString("N2")</MudTd>
                    }
                    else
                    {
                        <MudTd DataLabel="Current Safety Stock Lead Time">@context.CurrentSafetyStockLeadTime.ToString("N2")</MudTd>
                        <MudTd DataLabel="Current Cost">@context.CurrentCost.ToString("N2")</MudTd>
                        <MudTd DataLabel="New Cost">@context.NewCost.ToString("N2")</MudTd>
                    }

                    <MudTd DataLabel="Savings">
                        <MudChip T="string"
                                 Color="@(context.Savings > 0 ? Color.Success : Color.Error)"
                                 Size="Size.Small">
                            @context.Savings.ToString("N2")
                        </MudChip>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

@code {
    private string partNumber = "";
    private string mfgCode = "";
    private string simulationMode = "Parts";
    private int newSafetyStockParts = 0;
    private decimal newSafetyStockLeadTime = 0m;

    private List<SafetyStockSimulationResult> simulationResults = new();
    private string errorMessage = "";
    private string selectedTimePeriod = "Year";

    // Called after MudSelect value changes
    private async Task OnTimePeriodChanged()
    {
        if (simulationResults.Any())
            RecalculateSavings();

        await InvokeAsync(StateHasChanged);
    }

    private string GetSavingsLabel() => selectedTimePeriod switch
    {
        "Week" => "Per Week",
        "Month" => "Per Month",
        "Quarter" => "Per Quarter",
        "6Months" => "Per 6 Months",
        "Year" => "Per Year",
        _ => "Per Year"
    };

    private decimal GetTimeMultiplier() => selectedTimePeriod switch
    {
        "Week" => 7m / 365m,
        "Month" => 30.44m / 365m,
        "Quarter" => 91.25m / 365m,
        "6Months" => 182.5m / 365m,
        "Year" => 1m,
        _ => 1m
    };

    private void RecalculateSavings()
    {
        var multiplier = GetTimeMultiplier();
        foreach (var r in simulationResults)
            r.Savings = r.AnnualSavings * multiplier;
    }

    private async Task RunSimulation()
    {
        simulationResults.Clear();
        errorMessage = "";

        try
        {
            var sql = simulationMode == "Parts"
                ? BuildPartsSql()
                : BuildLeadTimeSql();

            DataTable dt = await SnowflakeService.QueryAsync(
    sql,
    "ManufacturingEnterpriseDataProducts"
);

            var multiplier = GetTimeMultiplier();

            foreach (DataRow row in dt.Rows)
            {
                var site = row["SITE"]?.ToString() ?? "";
                var partNum = row["PART_NUMBER"]?.ToString() ?? "";

                if (simulationMode == "Parts")
                {
                    var currentStock = row["SAFETY_STOCK_NR_OF_PARTS"] == DBNull.Value ? 0 : Convert.ToInt32(row["SAFETY_STOCK_NR_OF_PARTS"]);
                    var price = row["STANDARD_PRICE"] == DBNull.Value ? 0m : Convert.ToDecimal(row["STANDARD_PRICE"]);
                    var currency = row["CURRENCY"]?.ToString() ?? "";

                    var currentValue = currentStock * price;
                    var newValue = newSafetyStockParts * price;

                    var annualSavings = currentValue - newValue;
                    var savings = annualSavings * multiplier;

                    simulationResults.Add(new SafetyStockSimulationResult
                    {
                        Site = site,
                        PlanningPoint = row["PLANNING_POINT"]?.ToString() ?? "",
                        PartNumber = partNum,
                        MfgCode = row["MFG_SUPPLIER_CODE"]?.ToString() ?? "",
                        CurrentSafetyStock = currentStock,
                        StandardPrice = price,
                        Currency = currency,
                        CurrentValue = currentValue,
                        NewValue = newValue,
                        AnnualSavings = annualSavings,
                        Savings = savings
                    });
                }
                else
                {
                    var currentStockLt = row["SAFETY_STOCK_LEAD_TIME"] == DBNull.Value ? 0m : Convert.ToDecimal(row["SAFETY_STOCK_LEAD_TIME"]);
                    var tiedUpCapital = row["TIED_UP_CAPITAL"] == DBNull.Value ? 0m : Convert.ToDecimal(row["TIED_UP_CAPITAL"]);
                    var leadTime = row["LEAD_TIME"] == DBNull.Value ? 0m : Convert.ToDecimal(row["LEAD_TIME"]);

                    // Same assumption as your original: LEAD_TIME is in weeks
                    var carryingCostPerUnitPerYear = leadTime > 0 ? (tiedUpCapital / leadTime) * 52m : 0m;

                    var currentAnnualCost = currentStockLt * carryingCostPerUnitPerYear;
                    var newAnnualCost = newSafetyStockLeadTime * carryingCostPerUnitPerYear;

                    var annualSavings = currentAnnualCost - newAnnualCost;
                    var savings = annualSavings * multiplier;

                    simulationResults.Add(new SafetyStockSimulationResult
                    {
                        Site = site,
                        PlanningPoint = row["PLANNING_POINT"]?.ToString() ?? "",
                        PartNumber = partNum,
                        MfgCode = row["MFG_SUPPLIER_CODE"]?.ToString() ?? "",
                        CurrentSafetyStockLeadTime = currentStockLt,
                        CurrentCost = currentAnnualCost,
                        NewCost = newAnnualCost,
                        AnnualSavings = annualSavings,
                        Savings = savings
                    });
                }
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error running simulation: {ex.Message}";
        }
    }

    // ---------- SQL builders (single query each) ----------
    // NOTE: This version uses safe literal escaping because I don't know your SnowflakeService parameter support.
    // If your SnowflakeService supports parameters, I can give you the parameterized version too.
    private string BuildPartsSql()
    {
        var where = BuildOptionalFilters("ss");
        return $@"
SELECT
  ss.SITE,
  ss.PLANNING_POINT,
  ss.PART_NUMBER,
  ss.MFG_SUPPLIER_CODE,
  ss.SAFETY_STOCK_NR_OF_PARTS,
  pi.STANDARD_PRICE,
  pi.CURRENCY
FROM MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED ss
LEFT JOIN MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.PART_INFORMATION_AS_MANUFACTURED.PART_INFORMATION_AS_MANUFACTURED pi
  ON pi.SITE = ss.SITE
 AND pi.PART_NUMBER = ss.PART_NUMBER
WHERE ss.SITE = 'VCT'
{where}
ORDER BY ss.PART_NUMBER DESC";
    }

    private string BuildLeadTimeSql()
    {
        var where = BuildOptionalFilters("ss");
        return $@"
SELECT
  ss.SITE,
  ss.PLANNING_POINT,
  ss.PART_NUMBER,
  ss.MFG_SUPPLIER_CODE,
  ss.SAFETY_STOCK_LEAD_TIME,
  ih.THEORETICAL_MIN_STOCK_VALUE AS TIED_UP_CAPITAL,
  ih.SAFETY_STOCK_LEAD_TIME_IN_SHIFTS AS LEAD_TIME
FROM MANUFACTURING_ENTERPRISE_DATA_PRODUCTS.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED.SAFETY_STOCK_SETTINGS_AS_MANUFACTURED ss
LEFT JOIN MANUFACTURING_BUSINESS_DATA_PRODUCTS.INVENTORY_BY_PURPOSE.INVENTORY_HEALTH ih
  ON ih.FACTORY = ss.SITE
 AND ih.PART_NUMBER = ss.PART_NUMBER
WHERE ss.SITE = 'VCT'
{where}
ORDER BY ss.PART_NUMBER DESC";
    }

    private string BuildOptionalFilters(string alias)
    {
        var filters = "";

        if (!string.IsNullOrWhiteSpace(partNumber))
        {
            filters += $" AND {alias}.PART_NUMBER = '{EscapeSqlLiteral(partNumber.Trim())}'";
        }

        if (!string.IsNullOrWhiteSpace(mfgCode))
        {
            filters += $" AND {alias}.MFG_SUPPLIER_CODE = '{EscapeSqlLiteral(mfgCode.Trim())}'";
        }

        return filters;
    }

    // Basic escaping for SQL string literals: ' => ''
    private static string EscapeSqlLiteral(string value) => value.Replace("'", "''");

    // ---------- Result model ----------
    public class SafetyStockSimulationResult
    {
        public string Site { get; set; } = "";
        public string PlanningPoint { get; set; } = "";
        public string PartNumber { get; set; } = "";
        public string MfgCode { get; set; } = "";

        // Parts mode
        public int CurrentSafetyStock { get; set; }
        public decimal StandardPrice { get; set; }
        public string Currency { get; set; } = "";
        public decimal CurrentValue { get; set; }
        public decimal NewValue { get; set; }

        // LeadTime mode
        public decimal CurrentSafetyStockLeadTime { get; set; }
        public decimal CurrentCost { get; set; }
        public decimal NewCost { get; set; }

        // Common
        public decimal AnnualSavings { get; set; }
        public decimal Savings { get; set; }
    }
}