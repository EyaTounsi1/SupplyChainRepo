@page "/forecast-digital-twin"
@layout MainLayout
@inject IForecastService ForecastService

<MudText Typo="Typo.h3">Forecast & Digital Twin</MudText>

<MudPaper Class="pa-4 mb-4">
    <MudText Typo="Typo.h6" Class="mb-3">Forecast Parameters</MudText>
    <MudSelect T="int"
               Label="Time Frame (Months)"
               @bind-Value="selectedMonths"
               @bind-Value:after="LoadForecastData"
               Dense="true"
               Class="mb-3">
        <MudSelectItem T="int" Value="1">1 Month</MudSelectItem>
        <MudSelectItem T="int" Value="3">3 Months</MudSelectItem>
        <MudSelectItem T="int" Value="6">6 Months</MudSelectItem>
        <MudSelectItem T="int" Value="12">12 Months</MudSelectItem>
    </MudSelect>

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="selectedPartNumber" 
                          @bind-Value:after="LoadForecastData"
                          Label="Part Number" 
                          Variant="Variant.Outlined" 
                          Clearable="true" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudTextField @bind-Value="selectedMfgCode" 
                          @bind-Value:after="LoadForecastData"
                          Label="MFG Code" 
                          Variant="Variant.Outlined" 
                          Clearable="true" />
        </MudItem>
    </MudGrid>
</MudPaper>

@if (isLoading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    <MudText>Loading forecast data...</MudText>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <MudAlert Severity="Severity.Error">@errorMessage</MudAlert>
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">GIT and WIP Over Time</MudText>
        <MudChart ChartType="ChartType.Line" 
                  ChartSeries="chartSeries" 
                  XAxisLabels="chartLabels" 
                  Width="100%" 
                  Height="400px" />
    </MudPaper>

    <MudTable Items="@forecastItems" Hover="true" Striped="true">
        <HeaderContent>
            <MudTh>Site</MudTh>
            <MudTh>Part Number</MudTh>
            <MudTh>Date</MudTh>
            <MudTh>WIP Balance</MudTh>
            <MudTh>GIT Balance</MudTh>
            <MudTh>Total Capital (M SEK)</MudTh>
            <MudTh>Safety Stock</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Site</MudTd>
            <MudTd>@context.Part_Number</MudTd>
            <MudTd>@context.Date.ToShortDateString()</MudTd>
            <MudTd>@context.Wip_Balance.ToString("N0")</MudTd>
            <MudTd>@context.Git_Balance.ToString("N0")</MudTd>
            <MudTd>@context.Total_Capital_M_Sek.ToString("N2")</MudTd>
            <MudTd>@context.Safety_Stock_Nr_Of_Parts?.ToString("N0")</MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private List<ForecastItem> forecastItems = new();
    private bool isLoading = true;
    private string errorMessage = string.Empty;
    private int selectedMonths = 3;
    private string? selectedPartNumber;
    private string? selectedMfgCode;
    private List<ChartSeries> chartSeries = new();
    private string[] chartLabels = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadForecastData();
    }

    private async Task LoadForecastData()
    {
        isLoading = true;
        errorMessage = string.Empty;
        try
        {
            forecastItems = await ForecastService.GetForecastDataAsync(siteFilter: null, partNumberFilter: selectedPartNumber, mfgCodeFilter: selectedMfgCode, months: selectedMonths);

            // Prepare chart data
            var aggregatedData = forecastItems
                .GroupBy(x => x.Date)
                .Select(g => new
                {
                    Date = g.Key,
                    GitTotal = g.Sum(x => x.Git_Balance),
                    WipTotal = g.Sum(x => x.Wip_Balance)
                })
                .OrderBy(x => x.Date)
                .ToList();

            chartLabels = aggregatedData.Select(x => x.Date.ToShortDateString()).ToArray();
            chartSeries = new List<ChartSeries>
            {
                new ChartSeries { Name = "GIT Balance", Data = aggregatedData.Select(x => (double)x.GitTotal).ToArray() },
                new ChartSeries { Name = "WIP Balance", Data = aggregatedData.Select(x => (double)x.WipTotal).ToArray() }
            };
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading forecast data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}